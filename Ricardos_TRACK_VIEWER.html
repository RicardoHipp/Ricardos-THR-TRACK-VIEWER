<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricardos Track Viewer</title>
    <link rel="stylesheet" href="CSS/style.css">

</head>

<body>

    <header>
        <div
            style="width: 100%; max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 1.5rem 2rem;">
            <div>
                <button id="backBtn" class="header-btn" onclick="resetView()" style="display: none;">â¬… Load New File</button>
                <button id="galleryBtn" class="header-btn" onclick="showGallery()" style="display: none;">â¬… Back to Gallery</button>
            </div>
            <h1>Ricardos <span style="color: white; opacity: 0.8;">TRACK VIEWER</span></h1>
            <div></div> <!-- Spacer -->
        </div>
    </header>

    <div class="container">

        <div class="upload-zone" id="dropZone">
            <div class="upload-icon">ðŸ“‚</div>
            <h3>Drag & Drop .thr file here</h3>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">or click to browse single file</p>
            
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button onclick="document.getElementById('fileInput').click()" style="background-color: var(--surface-color); border: 1px solid var(--accent-color);">Select Single File</button>
                <button onclick="triggerFolderSelect()">Select Folder</button>
            </div>

            <input type="file" id="fileInput" accept=".thr">
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;">
        </div>

        <!-- NEW: Gallery View -->
        <div id="galleryView" class="gallery-view" style="display: none; width: 100%;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="margin: 0;">Track Library <span id="libraryCount" style="font-size: 1rem; color: var(--text-secondary); font-weight: normal;">(0 files)</span></h2>
                <input type="text" id="searchLibrary" placeholder="Search tracks..." style="padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; background: var(--surface-color); color: white;">
            </div>
            <div id="galleryGrid" class="gallery-grid">
                <!-- Thumbnails will be injected here -->
            </div>
        </div>

        <div class="workspace" id="workspace">
            <!-- Left: Canvas -->
            <div class="canvas-container" id="canvasContainer">
                <canvas id="trackCanvas" width="1200" height="1200"
                    style="position: absolute; top: 0; left: 0;"></canvas>
                <canvas id="cursorCanvas" width="1200" height="1200"
                    style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
            </div>

            <!-- Right: Sidebar (Stats + Controls) -->
            <div class="sidebar">

                <!-- Stats moved here -->
                <div class="stats" id="statsPanel">
                    <div class="stat-card">
                        <div class="stat-value" id="pointCount">0</div>
                        <div class="stat-label">Points</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="startTheta">0.00</div>
                        <div class="stat-label">Start Theta</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maxRho">0.00</div>
                        <div class="stat-label">Max Radius</div>
                    </div>
                </div>

                <div class="controls-row">
                    <!-- Controls moved here -->
                    <div id="controls" style="background: var(--surface-color); padding: 1.5rem; border-radius: 1rem;">
                        <h3 style="margin-top: 0; margin-bottom: 1.5rem;">Modify Track</h3>

                        <!-- Start Position Toggle -->
                        <div style="margin-bottom: 1.5rem;">
                            <label
                                style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.875rem;">Start
                                Position (Cleaning Direction)</label>
                            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <label
                                    style="display: flex; align-items: center; gap: 0.5rem; color: white; cursor: pointer;">
                                    <input type="radio" name="startPos" value="center" checked
                                        onchange="applyRotations()" style="accent-color: var(--accent-color);">
                                    Center (0,0) â†’ Outward
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: 0.5rem; color: white; cursor: pointer;">
                                    <input type="radio" name="startPos" value="edge" onchange="applyRotations()"
                                        style="accent-color: var(--accent-color);">
                                    Edge (1,0) â†’ Inward
                                </label>
                            </div>
                            <!-- Pre-Clean Checkbox -->
                            <div style="margin-top: 0.75rem;">
                                <label
                                    style="display: flex; align-items: center; gap: 0.5rem; color: #94a3b8; cursor: pointer; font-size: 0.9rem;">
                                    <input type="checkbox" id="preCleanCheck" onchange="handlePreCleanChange()"
                                        style="accent-color: #94a3b8;">
                                    Pre-Clean (Wipe)
                                </label>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <!-- Cleaning Circles Slider -->
                            <label
                                style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.875rem;">Cleaning
                                Circles (Integer)</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">
                                <input type="range" id="circlesSlider" min="-100" max="100" step="1" value="0"
                                    style="flex: 1; accent-color: var(--accent-color);">
                                <input type="number" id="circlesInput" min="-100" max="100" step="1" value="0"
                                    style="width: 60px; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--text-secondary); color: white; border-radius: 0.5rem; text-align: center;">
                            </div>

                            <!-- Fine Rotation Slider -->
                            <div style="margin-bottom: 1.5rem;">
                                <!-- Fine Rotation Slider -->
                                <label
                                    style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.875rem;">Fine
                                    Rotation (0-360Â°)</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">
                                    <input type="range" id="fineSlider" min="0" max="360" step="1" value="0"
                                        style="flex: 1; accent-color: var(--accent-color);">
                                    <input type="number" id="fineInput" min="0" max="360" step="1" value="0"
                                        style="width: 60px; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--text-secondary); color: white; border-radius: 0.5rem; text-align: center;">
                                </div>

                                <!-- Track Thickness Slider -->
                                <label
                                    style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.875rem;">Track
                                    Thickness & Style</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <input type="range" id="thicknessSlider" min="1" max="50" step="1" value="15"
                                        style="flex: 1; accent-color: var(--accent-color);">
                                    <span id="thicknessValue"
                                        style="color: var(--text-secondary); font-size: 0.9rem; width: 30px; text-align: right;">15px</span>
                                </div>
                            </div>
                        </div>

                        <!-- Playback Controls -->
                        <div
                            style="margin-bottom: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                            <label
                                style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.875rem;">Playback</label>

                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                <button id="playBtn" onclick="togglePlay()"
                                    style="flex: 2; background-color: var(--accent-color);">â–¶ Play</button>
                                <button onclick="stopPlay()" style="flex: 1; background-color: #334155; color: white;">â– 
                                    Stop</button>
                            </div>

                            <label
                                style="display: block; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.75rem;">Speed</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="range" id="speedSlider" min="1" max="100" step="1" value="10"
                                    style="flex: 1; accent-color: var(--accent-color);">
                                <span id="speedValue"
                                    style="color: var(--text-secondary); font-size: 0.8rem; width: 40px; text-align: right;">10x</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <button onclick="normalizeTrack()"
                                style="width: 100%; background-color: var(--surface-color); border: 1px solid var(--text-secondary); color: var(--text-primary);">Reset
                                to 0</button>
                            <button onclick="downloadTrack()" style="display: block; width: 100%;">ðŸ’¾ Save Modified
                                .thr</button>
                        </div>
                    </div>

                    <!-- Code Preview -->
                    <div
                        style="background: var(--surface-color); padding: 1.5rem; border-radius: 1rem; flex: 1; min-height: 200px; display: flex; flex-direction: column;">
                        <h3 style="margin-top: 0; margin-bottom: 1rem;">Preview (First 10 lines)</h3>
                        <pre id="codePreview"
                            style="background: var(--bg-color); padding: 1rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.8rem; overflow-x: auto; flex: 1; margin: 0; color: #a5b4fc;"></pre>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- FIX START MODAL -->
    <div id="fixStartModal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-top: 0; color: var(--accent-color);">Start Position Suspicious</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.5;">
                This track does not start at <strong>0,0</strong> (Center) or <strong>0,1</strong> (Edge).<br>
                It starts at a rotated position, which might be incorrect.
            </p>
            <p style="color: white; margin-bottom: 2rem; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.5rem; font-family: monospace;"
                id="modalCurrentStart">
                Current Start: ?
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button onclick="confirmFixStart(true)"
                    style="background-color: var(--accent-color); color: var(--bg-color);">
                    âœ… Yes, Add Start Point
                </button>
                <button onclick="confirmFixStart(false)"
                    style="background-color: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary);">
                    No, keep as is
                </button>
            </div>
        </div>
    </div>

    <script src="JS/track-viewer.js" defer></script>
</body>

</html>